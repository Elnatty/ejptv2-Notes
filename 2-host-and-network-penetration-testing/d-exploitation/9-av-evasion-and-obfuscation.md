# 9 - AV Evasion & Obfuscation

## <mark style="color:red;">AV Evasion With Shelter</mark>

### **Defense Evasion**

* Defense Evasion consists of techniques that adversaries use to avoid detection throughout their compromise. Techniques used for defense evasion include uninstalling/disabling security software or **obfuscating/encrypting** data and scripts. Adversaries also leverage and abuse trusted processes to hide and masquerade their malware. - MITRE.

### **AV Detection Methods**

* AV software will typically utilize signature, heuristic and behavior based detection.

1. **- Signature based detection** - An AV signature is a unique sequence of bytes that uniquely identifies malware. As a result, you will have to ensure that your obfuscated exploit or payload doesn't match any known signature in the AV database. We can bypass signature-based detection by modifying the malware's byte sequence, therefore changing the signature.
2. **- Heuristic-based detection** - Relies on rules or decisions to determine whether a binary is malicious. It also looks for specific patterns within the code or program calls.
3. **- Behavior based-detection** - Relies on identifying malware by monitoring it's behaviour. (Used for newer strains of malware).

### **AV Evasion Techniques**

1. &#x20;**On-disk Evasion Techniques**

* **Obfuscation** - Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE.
* **Encoding** - Encoding data is a process involving changing data into a new format using a scheme. Encoding is a reversible process; data can be encoded to a new format and decoded to its original format.
* **Packing** - Generate executable with new binary structure with a smaller size and therefore provides the payload with a new signature.
* **Crypters** - Encrypts code or payloads and decrypts the encrypted code in memory. The decryption key/function is usually stored in a stub.

2. **In-Memory Techniques**

* Focuses on manipulation of memory and does not write files to disk.
* Injects payload into a process by leveraging various Windows APIs.
* Payload is then executed in memory in a separate thread.

### **Practical Demonstration**

[**https://www.shellterproject.com/**](https://www.shellterproject.com/)

{% code overflow="wrap" lineNumbers="true" %}
```bash
# Install Shelter & Wine (shelter is a .exe program).
sudo apt-get install shellter
sudo dpkg --add-architecture i386
sudo apt-get install wine32 # install wine32 bit.

/usr/share/windows-resources/shellter # Location of the Shellter folder
sudo wine shellter.exe # Execute Shellter

# All instructions concerning the use of Shellter can be accessed through the program itself.
```
{% endcode %}





## <mark style="color:red;">Obfuscating PowerShell Code</mark>

* Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE.
* As a penetration tester, you will find yourself working with PowerShell code frequently. Most AV solutions will immediately flag malicious PowerShell code, as a result, you must be able to obfuscate/encode your PowerShell code ans scripts in order to avoid detection.

### **Invoke-Obfuscation**

* Invoke-Obfuscation is an open source PowerShell v2.0+ compatible PowerShell command and script obfuscator.
* Github Repo: [https://github.com/danielbohannon/Invoke-Obfuscation](https://github.com/danielbohannon/Invoke-Obfuscation)

### **Practical Demonstration**

{% code overflow="wrap" lineNumbers="true" %}
```bash
# To install Invoke-Obfuscation, clone the Github repo and do:
sudo apt-get install powershell

pwsh # Launch a powershell session on the local system
pwsh > Import-Module ./Invoke-Obfuscation.psd1
pwsh > Invoke-Obfuscation # Launch Invoke-Obfuscation

# Prepare the PowerShell code by adjusting the LHOST and LPORT options and by removing "<powershell -nop -c> and the first and last quotation marks"

IO > SET SCRIPTPATH <pathToShellCode> #Choose the PowerShell code to obfuscate
#Choose the way you want to obfuscate the shell code and it will return the newly obfuscated shellcode!
```
{% endcode %}



